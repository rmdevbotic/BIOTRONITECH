<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title></title>
</head>
<body>
<script>
(async () => {
  const TOKEN = "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJGZWxpcGUgQ2FzdHJvIiwiYnVzaW5lc3NJZCI6ImJpb3Ryb25pdGVjaGNvbG9tYmlhc2FzIiwibmFtZSI6IkZlbGlwZSBDYXN0cm8iLCJhcGkiOnRydWUsImlkIjoiWTdwUnFYNmJYcVcwdFRlWGFianIwb01Ma1ZqMiIsImV4cCI6MTkxNzU1NDgzOSwianRpIjoiWTdwUnFYNmJYcVcwdFRlWGFianIwb01Ma1ZqMiJ9.ssfoPx1Af8Cz9f47u5ed6L0Wgq_nQ7odMK3QtZCp0tV_VxASAflyzCWmOn7toPOSo_o1TwYu5TSNNSxZIcbcdg";

  const numero = new URLSearchParams(window.location.search).get('number');

  const respuestaIp = await fetch("https://api.ipify.org?format=json", { cache: "no-store" });
  const datosIp = await respuestaIp.json();
  const ip = datosIp.ip;

  const obtenerChat = await fetch(
    `https://api.botmaker.com/v2.0/chats?channel-id=biotronitechcolombiasas-whatsapp-573172541107&contact-id=${numero}`,
    {
      method: "GET",
      headers: {
        Accept: "application/json",
        "access-token": TOKEN
      }
    }
  );

  const datosChat = await obtenerChat.json();
  const idChat = datosChat?.items?.[0]?.chat?.chatId;

  const ahora = new Date();
  const diferencia = -5;
  const local = new Date(ahora.getTime() + diferencia * 60 * 60 * 1000);
  const fecha = local.toISOString().split("T")[0];
  const hora = local.toTimeString().split(" ")[0];
  const ipConFecha = `${numero},${ip},${fecha} ${hora}`;

  await fetch(`https://api.botmaker.com/v2.0/chats/${idChat}`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      Accept: "application/json",
      "access-token": TOKEN
    },
    body: JSON.stringify({
      variables: { 
        BIOTRONITECH_datosUsuario: ipConFecha,
        BIOTRONITECH_autorizado: true
      }
    })
  });

  window.location.replace("https://biotronitech.com.co/autorizacion-tratamiento-de-datos-personales/");
  
</script>
</body>
</html>

